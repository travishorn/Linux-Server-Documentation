[[{"l":"Linux Server Documentation","p":["A small collection of simple instructions for setting up and configuring a Linux server from scratch.","This guide is intended for novice system administrators or even advanced ones that are not familiar with Linux, nginx, or some of the other covered topics.","Includes OS, SSH, git, Node.js, nginx, MariaDB, and more. Topics are split into ordered pages for easy viewing. While each section does build upon the previous ones, the configuration is basic and common enough that you may be able to jump to any section and follow the instructions from there.","If you follow this guide from start to finish, you will have a working Debian Linux server that...","you can connect to remotely","can host bare source code repositories","runs production web applications with continuous integration","serves content through a reverse-proxy over HTTP and HTTPS","is secured with a firewall","hosts a database with automatic backups","integrates database connectivity with a web app","provides web-based system monitoring","The end product is designed to be a baseline that you can extend with more functionality or harden for additional security depending on your needs."]}],[{"l":"Create a Virtual Machine with VirtualBox","p":["At this point, you can continue by installing the operating system.","Check the box for Enable EFI (special OSes only).","Click Audio from the pane on the left.","Click Finish.","Click Next.","Click OK.","Click Storage from the pane on the left.","Click System from the pane on the left.","Click the New button.","Click the Remove Controller button an icon of a green diamond with a red X over top of it. It is near the bottom of the window.","Click the Settings button.","Give the virtual machine a name. Example: \"myserver\".","If you are installing your server on bare hardware, or you have another virtualization solution that you want to use, you can safely skip the steps on this page and go to the operating system installation steps.","If you don't already have it, download and install Oracle VM VirtualBox Manager.","Leave Create a Virtual Hard Disk Now selected and enter a disk size. It should probably be at least 20 GB. Choose a size that will accomodate any software, application files, and database data you will need.","Open Oracle VM VirtualBox Manager.","Uncheck Enable Audio.","Under Base Memory, choose an appropriate amount. Half of the available memory is a good choice, but you may want to choose less or more depending on your needs.","Under Boot Order, uncheck Floppy and then move it below Hard Disk.","Under Chipset, choose ICH9.","Under Processors, choose an appropriate amount. Half of the available processors is a good choice, but you may want to choose less or more depending on your needs.","Under Storage Devices, click to highlight Controller: IDE.","Under Type, choose Linux.","Under Version, choose the Linux version you will be installing. Example:\"Debian 11 Bullseye (64-bit)\".","VirtualBox will not use all of the specified space immediately. It will only use what it needs, up to a maximum of whatever you specify."]}],[{"l":"Install the Debian Linux Operating System"},{"l":"Prerequisites","p":["A new virtual machine has been created or a physical machine is ready for fresh operating system installation"]},{"l":"Download","p":["Access the boot menu. You may need to press a specific key on the keyboard. Watch your screen for instructions. If you miss it, you can restart the machine and try again. The goal is to get to the boot menu and boot from the inserted USB drive that has the Debian installation ISO loaded.","Click Choose.","Click OK.","Click Start and look for Rufus. Click it to launch Rufus.","Click START.","Click Storage from the pane on the left.","Click the Adds optical drive. button an icon of a blue disc with a green plus sign over top of it. It is next to the text \"Controller: SATA\".","Click the Settings button.","Click the Start button in Oracle VM VirtualBox Manager. Shortly, a window will appear containing your virtual machine.","Go to rufus.ie.","Go to the Installing Debian via the Internet page.","If you're setting up a physical machine, you'll need to follow the steps in this section to create a bootable flash drive with the ISO loaded.","If you're setting up a virtual machine, you'll need to follow the steps in this section to attach the ISO image you downloaded earlier as an optical disk.","Look for the list of virtual machines on the left. Click to highlight the virtual machine to which you want to install the operating system.","Make sure your server machine is powered off.","Navigate to where the ISO image you downloaded earlier is stored. Click to highlight it, then click Open.","Once Rufus is finished creating the installation media, remove the flash drive from your workstation.","Once the download completes, run the installer and follow its instructions to install Rufus.","Open Oracle VM VirtualBox Manager.","Plug a USB flash drive into your machine.","Plug the flash drive into the server.","Press the power button to boot it up.","The contents of this flash drive will be erased in the next few steps. Make a copy if you don't want to lose anything.","The ISO image will start downloading. Make a note of where this ISO image is stored on your computer.","The next steps will depend on whether you are installing the operating system to physical hardware or to a virtual machine. Please choose the tab below that corresponds to your installation.","The Optical Disk Selector window appears. Click the Add button.","Under Boot selection, click SELECT.","Under Device, select the flash drive you want to use.","Under Storage Devices, click to highlight Controller: SATA","Under the Download section, click Rufus 3.22(the version number might be different, depending on when you are reading this).","Under the section labeled Small CDs or USB sticks, click the architecture your server uses. If you're not sure, it's probably amd64."]},{"l":"Install the Operating System","p":["After a few moments, a message will appear stating that the installation is complete. Click Continue.","Choose the keymap your keyboard uses and click Continue.","Choose your language and click Continue.","Choose your location and click Continue.","Click Continue.","Do not forget this password. You may want to record it in some password management software.","If you see a message about \"UEFI\" and the installer asks you if you want to Force UEFI installation?, choose Yes and click Continue.","If you're using a virtual machine, making the virtual machine's name in VirtualBox and the hostname here match is a good idea.","Leave the textbox for HTTP proxy information blank and click Continue.","Make sure Graphical install is selected and press Enter. If you don't make a selection within a few seconds, Graphical install will be automatically chosen.","Once the Debian installater is booted, you will see a screen with some installation options.","The machine will reboot and the login screen will appear.","Under Amount of volume group to use for guided partitioning, leave the default (\"max\") entered.","Under Choose a password for the new user, enter a strong, unique password that you will log in with.","Under Choose softare to install, uncheck everything and then check SSH server and standard system utilities.","Under Debian archive mirror country, choose your country or the closest country to you.","Under Debian archive mirror, leave the default selected.","Under Domain name, enter the domain name for this machine. Make sure it matches other machines on your network. If you don't have any other machines on the network configured for a specific domain, you can choose any domain name here. Example: \"localdomain\".","Under Full name for the new user, enter your name. First and last name is good enough. It's just something to identify you on the system.","Under Hostname, enter a descriptive hostname. Example: \"myserver\".","Under Participate in the package usage survey?, leave No selected and click Continue.","Under Partitioning method, click to highlight Guided - use entire disk and set up LVM.","Under Partitioning scheme, leave All files in one partition (recommended for new users) selected.","Under Re-enter password to verify, enter the same password again.","Under Root password, choose and enter a strong, unique password for the root user.","Under Scan extra installation media?, leave No selected.","Under Select disk to partition, make sure the correct hard disk is selected. There may only be one option. The size should match the actual hard drive in the machine (or whatever size you entered for the Disk Size when creating the virtual machine.)","Under Select your time zone, click to highlight the timezone in use where the server is located.","Under Username for your account, enter the username you want to log in with. Your first name, all-lowercase is a good option. Another option is your first initial and your last name, all-lowercase.","Under Write the changes to disks and configure LVM?, choose Yes.","Under Write the changes to disks?, choose Yes."]},{"l":"Set up sudo","p":["Logging in and doing things as the root user is not recommended. Instead, you should log in and do things with your user account, and only do things as root when necessary using sudo. We have to install and configure sudo first.","Log in as root with the password you chose during installation.","Install sudo.","Add your user account to the sudo group.","Make sure to replace [your username] with the username you chose during installation. All members of the sudo group can execute commands as root when necessary using sudo.","You are now ready to use your new server.","Next, you will probably want to configure port forwarding so you can enable remote connections to the server."]}],[{"l":"Port Forwarding in VirtualBox","p":["Any time you need to connect to your virtual machine remotely (whether by SSH, HTTP, or another protocol), you'll need to make sure the appropriate port is forwarded from your host machine.","Click Network from the pane on the left.","Click OK again.","Click OK.","Click Port Forwarding.","Click the Adds new port forwarding rule. button an icon of a green diamond with a green plus sign on top of it. It's on the right side.","Click the Settings button.","Click to select the virtual machine from the list on the left.","If you have multiple virtual machines which you will be SSHing into, or you already have an SSH server running on the host machine itself, you may want to enter a different Host Port. In that case, choose any number you like between 1024 and 49152. Just make sure it is not in use by any other service.","In the table on the left, double-click Rule 1. This will allow you to edit the name of the rule. Type in the name of the service. For example, SSH.","Leave everything else blank.","Open Oracle VM VirtualBox Manager on the host machine.","the network adapter is attached to NAT (the default setting)","The steps below focus on SSH and port 22, but you can use this guide for any service and port.","This guide is only necessary if...","Under Guest Port, enter the port number that your virtual machine is listening on. For SSH, use port 22.","Under Host Port, enter the port number you want the host machine to listen on. This can be anything, but for simplicity, I recommend using the same as the guest port. For SSH, use port 22.","Under the Adapter 1 tab, click Advanced.","your server is running on a virtual machine, and"]},{"l":"Other Ports","p":["22","3000","3306","443","80","9090","HTTP","HTTPS","In this series of documentation, we will be setting up services that listen on the following ports. You should add a new rule to set up port forwarding for each of them.","MariaDB","Node.js","Port","Prometheus","Service","SSH","With the ports properly forwarded, you can start setting up remote connections to the server."]}],[{"l":"Access a Remote Shell with OpenSSH"},{"l":"Prerequisites","p":["Linux is installed and a user(s) has been created","If using a virtual machine, port 22 is forwarded"]},{"l":"Install OpenSSH on the Server","p":["OpenSSH server may already be installed on your server. Get the status of the sshd service to check.","If you see output that starts with something like the following, OpenSSH server is already installed and running. You can safely skip to the next section, Install OpenSSH on the Client.","If instead, you see an error like the following, OpenSSH server is not installed.","In that case, install OpenSSH server."]},{"l":"Install OpenSSH on the Client","p":["To connect to your server via OpenSSH, you will need to have the client installed on the workstation you want to connect from.","You may already have it installed. Try running ssh from a terminal.","If you see output that starts with something like the following, OpenSSH client is already installed and you can safely skip to the next section, Connect.","Otherwise, if you receive an error message, you must install OpenSSH client. The process will depend on your operating system.","Open Settings> Apps> Optional Features","Search for OpenSSH Client","Select Install","Install OpenSSH client using your package manager. For example, if you're using Debian Linux, run:"]},{"l":"Connect","p":["On your workstation machine (not the server), open up a Terminal.","If you're using a virtual machine, you can also connect to the server from the host machine.","Connect to the server via SSH.","Be sure to replace [your username] with your actual username on the server and replace [your server's IP address/hostname] with your server's actual IP address or hostname.","You may use localhost as the hostname if...","you're using a virtual machine,","you're connecting from the host machine, and","you have port 22 forwarded","If you set up your SSH port to something other than 22, you must add -p [port number] to the end of the command.","If asked if you want to continue connecting, type yes and press Enter","You will be prompted for your user's password on the server. Enter it and press Enter.","You are now logged in to your server remotely via SSH.","While using password authentication with OpenSSH like this is convenient, you may consider the added benefits of configuring public key authentication."]}],[{"l":"Public Key Authentication"},{"l":"Prerequisites","p":["OpenSSH server is running on your server","OpenSSH client is installed on your workstation"]},{"l":"Prepare the Server","p":["The steps in this section need to be done once per local user account on the server.","Log in to the server user account you want to use.","Create a directory called .ssh in the home directory.","Set the directory's permissions so only you, the owner can read, write, and execute it.","Create an empty authorized_keys file.","Set the file's permissions so only you, the owner can read and write to it.","Anyone who can provide a private key that matches the public keys stored in this file will have access to the account."]},{"l":"Generate an SSH Key Pair","p":["Next, create a key pair. A key pair is a public key and a matching private key. The public key will be added to the previously created authorized_keys file.","On your workstation (not the server), open up a Terminal.","Create a directory called .ssh in your home directory.","Change into the directory.","Generate a key pair.","For example:","You can replace [your name]@[location of workstation]-[timestamp] with anything you want. But I recommend the above because it will help identify a key by the name of the person it belongs to, the location it will be used from, and the date it was created.","Upon running the command, you will be asked for a passphrase. You can choose anything you want here, or you can leave it blank.","Make sure you understand the security implications of leaving the passphrase blank before you do it.","Two files are created. One without a file extension (the private key) and one with the file extension .pub(the public key).","Example:","myname@work-2023-05-01","myname@work-2023-05-01.pub","myname@work-2023-05-01 contains the private key that will need be provided any time you try to connect to the server. It is not recommended to copy this file to another machine. If you need to connect from multiple machines, create multiple key pairs. Protect this file like a password.","myname@work-2023-05-01.pub contains the public key that can be shared. Any user on any device which has this key entered into its authorized_keys file grants you access to the user account (as long as you can provide the private key)."]},{"l":"Add a Public Key to a User","p":["Once you have a key pair, you'll want to add the public key to a local user account on the server.","From your workstation, copy the public key into the server user's authorized_keys file.","Be sure to replace [public key filename] with the actual public key filename,[your username] with your actual username on the server, and [your server's IP address/hostname] with your server's actual IP address or hostname.","If you're using a virtual machine, you're connecting from the host machine, and you have port 22 forwarded, you can use localhost as your server's hostname.","The command will ask for the user's current password so it can log in and append the public key to the authorized_keys file."]},{"l":"Connecting to the Server using an SSH Key","p":["From your workstation, connect to the server, providing the SSH private key for authentication.","You will be asked for the key pair's passphrase (if any). Once authenticated, you will be connected to your server as before."]},{"l":"Using a Configured Host","p":["The command you must execute to connect to your server via SSH is tedious to type out. You can alleviate this with a configured host.","On your workstation, create or edit ~/.ssh/config.","Make sure to replace myserver and myusername with the appropriate values.","With that file saved, you can execute the much shorter ssh command.","While the HostName must be set to your server's actual IP address or hostname, the Host can be set to anything you like. It is like an alias that identifies the configured host."]},{"l":"Disabling Password Authentication","p":["Once SSH key authentication is set up and working correctly, I suggest disabling the less-secure password authentication method.","Edit /etc/ssh/sshd_config. Somewhere in the file, add the following line.","Restart the SSH server.","From now on, users cannot use a password to authenticate their SSH sessions with the server; they must provide a valid private key."]},{"l":"Removing Access","p":["If you need to remove access from a particular key pair, edit the server user's~/.ssh/authorized_keys file. and delete the line which has the public key you want to remove.","Your server is now ready to handle remote connections with public key authentication. At this point, you are ready to set it up to host bare git repositories."]}],[{"l":"Set up a git Server"},{"l":"Prerequisites","p":["A working Linux server machine","You are logged in as a non-root user with sudo privileges"]},{"l":"Install git","p":["If it isn't already installed, install git."]},{"l":"Global configuration","p":["Set a default initial branch name in git","Feel free to change the name master above to anything you like. While master is the traditional default, main is also common.","Configure git to reconcile divergent branches by merging changes, rather than rebasing.","pull.rebase false is a preference. But either true or false, the configuration option must be set."]},{"l":"Create Storage Directory","p":["You'll need a place to store any git repositories. To keep things organized, create a separate directory for them.","Your server is now ready to host git repositories. Next, you should start creating new repositories on the server that developers can pull from and push to."]}],[{"l":"Create a New git Repository"},{"l":"Prerequisites","p":["The server has been set up as a git server","You are logged in as the non-root user"]},{"l":"Create and set permissions","p":["Initialize a bare repository in the home directory.","Change [repo name] to a name of your choosing. Example: my-app","Now developers who can authenticate as this local user can clone, pull from, and push to this repository."]}],[{"l":"Pull from and Push to a git Repository"},{"l":"Prerequisites","p":["The server has been set up as a git server","A bare repository has been created on the server","You can authenticate as the user where the repository is being hosted"]},{"l":"Working with the Remote Repository","p":["First, clone the repository from the server to your development machine.","Example:","You can use localhost as the hostname as long as...","you're using a virtual machine,","you're running git clone from the host machine, and","you have port 22 forwarded","You will be prompted to enter password for myuser.","A new directory named my-app(or whatever your repository is named) is created on your development machine. Change into it.","You can pull any new changes from the remote repository at any time.","And you can push your changes to it."]},{"l":"Public Key Authentication","p":["If you haven't set up public key authentication...","you will need to share the password for myuser with each developer who needs pull/push access.","Developers will also need to enter the password each time they pull/push.","Neither of the above conditions is ideal. You can solve both of these issues by setting up public key authentication.","Make sure you have...","set up public key authentication on your server","added your public key to the server user's authorized_keys file","added your server as a configured host on your workstation","The instructions for all of these is in the guide for Public Key Authentication.","Pull from and Push to a git Repository","With a configured host, users can interact with a server using the alias in the configuration file.","myserver here is the name of the configured host set up in ~/.ssh/config, not necessarily the server's hostname (although they can be the same).","You will be asked for your SSH key passphrase rather than the server user's password. This eliminates the need to share that password.","If you don't want to enter the SSH key passphrase each time, you can use an SSH agent (recommended - find more information online) or you can use a key pair with an empty passphrase (not recommended).","Now that pull and pushing code to the server is possible, you'll probably want to serve some apps. The next step would be installing the software of your choice (such as Node.js) that is required to run any apps."]}],[{"i":"install-nodejs","l":"Install Node.js"},{"l":"Prerequisites","p":["A working Linux server machine","You are logged in as a non-root user with sudo privileges"]},{"l":"Installation","p":["Binary distributions of Node.js are provided by NodeSource. Installing Node.js on Debian Linux via the NodeSource distributions is an officially supported method.","First, install curl.","Assume the root user.","Install the latest LTS Node.js release via NodeSource.","The above command(s) will install Node.js version 18.x. There may be a more recent LTS release. You can find out at https://nodejs.org.","Exit the root user shell.","Make sure Node.js is installed correctly by getting its version number.","It should display something like:","The exact version number might vary depending on when you are reading this guide."]},{"l":"Create an App Directory","p":["To stay organized, I recommend creating a directory to store any apps you might deploy.","You are now ready to run and serve Node.js apps. You may choose to write and/or run completely custom Node.js apps, or you may choose to go with a framework like Next.js."]}],[{"i":"serve-a-nextjs-app","l":"Serve a Next.js App"},{"l":"Prerequisites","p":["Node.js is installed","A Next.js app has been written and its source code is in a git repository accessible by the server","You are logged in to the server as a non-root user","If using a virtual machine, port 3000 is forwarded"]},{"l":"Clone the repository","p":["Use git clone to clone the repository into the ~/apps directory.","The repository could be located anywhere.","If it is hosted on the same server as you're currently using, (for example, inside the ~/repos directory), you can clone it by passing git clone the path to the repository.","Change into the repository.","Install the project's dependencies.","Disable Next.js telemetry.","Build the project.","Serve the project.","By default, the app will be accessible on port 3000."]},{"l":"Test the Application Server","p":["Open a web browser and navigate to http://[your server's IP address/hostname]:3000. You should see your Next.js app.","You can navigate to http://localhost:3000 as long as...","you're using a virtual machine,","are working from the host machine, and","you have port 3000 forwarded","This is a simple setup that isn't fault-tolerant or feasible to manage. You may want to manage your Node.js processes using a manager like PM2."]}],[{"i":"manage-nodejs-processes-with-pm2","l":"Manage Node.js Processes with PM2"},{"l":"Prerequisites","p":["A Node.js app (Next.js or otherwise) is servable","The Node.js app is not currently running","If using a virtual machine, port 3000 is forwarded"]},{"l":"Setup","p":["are working from the host machine, and","Copy the command.","Create the file ~/apps/ecosystem.config.js.","If you have more than one app, you can place more than one object in the apps array.","Install missing dependencies","Install PM2 globally using npm.","Log into the server","Open a web browser and navigate to http://[your server's IP address/hostname]:3000. You should see your Next.js app.","Paste it into your terminal and press Enter to run it.","PM2 will now automatically start the saved Node.js processes at system startup. Try restarting the machine to test it.","Pull changes to the cloned (running) app","Push changes to the repository","Rebuild the app","Reload the pm2 processes","Right now, the process for updating the app is...","Save the currently running configuration.","Start the process(es) using PM2.","That command will output a command that looks something like this:","View the startup script command.","You can automate steps 2-6 with continuous integration.","You can navigate to http://localhost:3000 as long as...","you have port 3000 forwarded","you're using a virtual machine,"]}],[{"l":"Continuous Integration"},{"l":"Prerequisites","p":["A Node.js app (Next.js or otherwise) has its source code hosted in a bare git repository on the server (for example, in ~/repos)","The app has been cloned to the server (for example, in ~/apps)","The app is being run and managed by PM2"]},{"l":"Set up CI","p":["Create a post-receive git hook by creating a file named ~/repos/[repo name]/hooks/post-receive.","On the line if [ master = $branch ]; then, master must be the name of the branch which should trigger CI when it's pushed to.","On the line pm2 reload [app name], the [app name] must be the name you set in ecosystem.config.js.","Make the hook executable.","The setup is complete. Here is the process this continuous integration solution follows:","A developer pushes changes to the repository","The post-receive hook in the bare repository is automatically executed","The hook pulls the changes to the production code in ~/apps","Any missing dependencies are installed","The production app is rebuilt","The processes are reloaded by PM2, one at a time for zero downtime","All of this happens automatically when changes are pushed to the repository."]},{"i":"reduce-downtime-on-a-nextjs-app","l":"Reduce Downtime on a Next.js App","p":["With the current configuration, there will still be some downtime when Next.js builds your app. During the build, it removes everything from the .next directory, then repopulates it. Since your running processes are accessing files in the .next directory, the app is temporarily unavailable.","You can solve this by having Next.js build into a temporary directory, then moving the built files over once the build is complete.","Edit ~/apps/[app name]/next.config.js. Add the distDir line below.","This allows us to set a build directory at build time.","Now edit ~/repos/[repo name]/hooks/post-receive. The changes are...","Modify the build command to set a temporary build directory .next_temp","Add a command to remove the old .next directory","Add a command to rename .next_temp to .next.","For now, the app is accessible directly on port 3000. Ultimately, you will probably want to serve the Node.js app(s) behind a reverse proxy like nginx for improved security, load balancing, caching, advanced URL rewriting, and simplified deployment."]}],[{"l":"Reverse Proxy Using nginx"},{"l":"Prerequisites","p":["A running web application on port 3000","If using a virtual machine, port 80 is forwarded"]},{"l":"Install nginx","p":["You should be able to visit http://localhost and see the \"Welcome to nginx!\" page."]},{"l":"Configure nginx","p":["Edit the nginx configuration file at /etc/nginx/sites-available/default.","location / { proxy_pass http://localhost:3000; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection'upgrade'; proxy_set_header Host $host; proxy_cache_bypass $http_upgrade; }","If successful, restart the nginx service to apply the changes.","In your web browser, visit http://[your server's IP address/hostname]. You should see your Node.js app.","If you're using a virtual machine, are working from the host machine, and you have port 80 forwarded, you can visit http://localhost."]},{"l":"Block Direct App Access","p":["All requests to the web application should go through port 80 (or 443 if you set up HTTPS/SSL later). However, the application is still listening on port 3000. Use a firewall to block external requests to port 3000. See separate guide."]}],[{"l":"Firewall Configuration with nftables","p":["Debian Linux comes with nftables installed by default.","Edit the nftables configuration file located at /etc/nftables.conf","Enable the nftables service so it starts when the machine starts.","Start the nftables service now","If the service is already running and you just want to apply changes you recently made to the configuration, just restart the service."]},{"l":"Add a New Firewall Rule","p":["Any time you want to allow traffic for a new service on a specific port, you must add a new firewall rule.","Edit the nftables configuration file located at /etc/nftables.conf","Find the line that looks like this:","Add the new port into the comma-separated list inside curly braces. For example, if you want to add a rule that allows port 3306, the line will look like this:","Some ports have aliases (like ssh and http) that nftables recognizes.","Restart nftables to apply the new rules."]},{"l":"More Rules","p":["For this series of guides, we will be setting up services that listen on the following ports. You should set up firewall rules for all of them:","SSH, port 22, alias ssh","HTTP, port 80, alias http","HTTPS, port 443, alias https","MariaDB, port 3306, alias mysql","Prometheus, port 9090"]}],[{"i":"httpsssl-on-nginx","l":"HTTPS/SSL on nginx"},{"l":"Prerequisites","p":["nginx configured as a reverse proxy for a web application","a domain name (or scroll down to the \"Self-Signed\" section below)","A firewall rule to accept traffic on TCP port 443 has been added","If using a virtual machine, port 443 is forwarded"]},{"l":"Prepare your nginx Configuration","p":["Edit /etc/nginx/sites-available/default","Find the line that starts with server_name and replace the _ character with the domain name the server will use. You can configure multiple domains by separating them with a space.","Save and close the file.","Verify the nginx configuration.","If all is well, reload nginx."]},{"l":"Use Certbot to enable HTTPS","p":["Use Certbot if your server is public-facing and you are ready to install a real certificate signed by Let's Encrypt(a Certificate Authority which issues certificates for free). Skip to the next section if you just want to use a self-signed certificate.","Install certbot and python3-certbot-nginx.","Generate the SSL certificate.","You will be asked some questions, including your email address. Answer the questions to continue.","Certbot automatically generates the certificate and configures nginx for you. It also sets a timer that runs periodically that will automatically renew your certificate before it expires.","With the firewall allowing connections and the certificate installed, you should be able to visit your domain using https:// and see your web app. You can also visit it via http:// and you should be automatically redirected to the https:// URL."]},{"l":"Self-Signed Certificate","p":["If you aren't ready to use a real certificate signed by an authority, you can use a self-signed certificate instead. Visitors to the site will receive a warning about the invalid certificate, but they can bypass it, making this a good option for testing and development.","Make a directory to store the certificate files.","Change into that directory."]},{"l":"Generate a Certificate","p":["If you have an actual certificate you want to use, you can skip this step.","You must answer a few questions about the certificate being generated. Most important is the common name. If you're using a custom domain name to reference this server, use that. For example myserver.dev. Otherwise, just use something like localhost.","Two new files, localhost.crt and localhost.key are generated at/etc/nginx/ssl."]},{"l":"Configuration","p":["Edit /etc/nginx/sites-available/default.","Above the existing server { block, add another, new server { block like so:","In the lower, already-existing server block, remove the first two lines (they both start with listen). Replace them with the following:","Save and close the file.","Test to make sure the nginx configuration is valid.","If it is, restart the nginx service.","You should now be able to visit https://localhost and see your web app. You can also visit http://localhost and you should be automatically redirected to https://localhost.","Since you're using a self-signed certificate, your browser will probably warn you that the certificate is invalid. You can usually bypass this by clicking Advanced and Proceed or something similar."]}],[{"l":"Storing Data with MariaDB"},{"l":"Prerequisites","p":["A firewall rule to accept traffic on TCP port 3306 has been added","If using a virtual machine, port 3306 is forwarded"]},{"l":"Install MariaDB"},{"l":"Create a Database and a User","p":["Log in as the root system user.","Create a database for your web application.","Create a user to represent your web application.","Replace [username] and [password] with the actual credentials you want your web applications to use when they authenticate to the database.","The % means that the user can connect from any IP address. Replace it with localhost to only allow local connections or replace it with an IP address to only allow connections from that IP address.","Grant database privileges to this user.","The same warning as above applies to this %.","Apply the privilege changes.","Exit the MariaDB REPL."]},{"l":"Allow Remote Connections","p":["Edit /etc/mysql/my.cnf.","Add the following lines at the end of the file.","Save and close the file.","Restart the database service."]}],[{"l":"Database Backups"},{"l":"Prerequisites","p":["MariaDB installed","One or more databases created","MariaDB has a root user which authenticates with the local filesystem account"]},{"l":"Install the Backup Utility"},{"l":"Create a Backup Script","p":["Create a backup script at /usr/local/bin/backup_databases.sh.","Make the script executable."]},{"l":"Configure Automatic Backups with systemd","p":["Create /etc/systemd/system/backup_databases.service.","Create /etc/systemd/system/backup_databases.timer.","Reload the system daemon to pick up the new service and timer.","Enable the timer so it starts when the system starts.","Start the timer now.","At this point, all MariaDB databases will be backed up to /var/mariadb/backup every day at midnight."]},{"l":"Manually Backing Up Databases","p":["You can back up databases at any time.","Or you could run the backup script.","Running the backup script will run the entire script, including the command which removes backups 14 days or older."]}],[{"l":"Database Backup Recovery"},{"l":"Prerequisites","p":["The database is MariaDB","mariadb-backup is installed","You have a compressed backup file containing the state of the database to which you want to recover"]},{"l":"Take a Manual Backup","p":["Before continuing with data recovery, I highly recommend creating a manual backup, in case you need to revert back to the state before recovery started.","Database Backup Recovery"]},{"l":"Recover the Data","p":["Create a directory for storing the recovered files temporarily. It can be named anything you like. Here it is named recovered.","Unzip the compressed database backup in the directory.","Prepare the recovery files. This is necessary because files created at backup time are not point-in-time consistent and MariaDB will reject the recovery if not properly prepared.","Stop MariaDB.","Remove all existing data files.","Restore the backup files.","Change ownership of the newly recovered files so that the mysql user can access them properly.","Start MariaDB.","The database is now restored back to the state it was in when the backup was taken.","Remove the recovery files as they are no longer needed."]}],[{"i":"connect-to-mariadb-from-a-nextjs-app","l":"Connect to MariaDB from a Next.js App"},{"l":"Prequisites","p":["A running Next.js app","A running MariaDB (or MySQL) instance with user access configured"]},{"l":"Install Dependencies","p":["This solution uses the knex and mysql2 packages. Install them as dependencies."]},{"l":"Set Environment Variables","p":["Set the following environment variables in whichever way makes sense for your situation. If you are connecting to a development database server from a development machine, you may create a file called .env.local in the root directory of your app.","You may need to change the host or the port depending on your setup."]},{"l":"Create a Database Connection File","p":["Create a new file called lib/db.ts.","We'll import this file into any file that needs to connect to the database."]},{"l":"Get Data from the Database Server-Side","p":["Inside a Next.js page like pages/index.tsx, import the db function from the file we just created..","Then create a getServerSideProps() function. Next.js will use this to get data server-side and pass them as props to the page.","Now, use the prop in the page's render function."]},{"l":"Using a Raw Query","p":["Knex has a built in raw() function that allows you to execute raw SQL. Unfortunately, the format of the data returned by this function doesn't work well with Next.js.","However, we can write a simple wrapper around it to help us.","Add the following to lib/db.ts.","Now on your page, you can import this function.","And you can use it to execute raw queries in getServerSideProps()."]}],[{"l":"Monitoring with Prometheus"},{"l":"Prerequisites","p":["A firewall rule to accept traffic on TCP port 9090 has been added","If using a virtual machine, port 9090 is forwarded"]},{"l":"Installation","p":["Copy the listed URL. It will be labeled something like prometheus-2.37.6.linux-amd64.tar.gz.","Create a new systemd service file called/etc/systemd/system/prometheus.service.","Create a new user that will run the Prometheus daemon.","Enable the Prometheus service so it starts when the system starts.","Go to https://prometheus.io/download/.","If you're using a virtual machine, are working from the host machine, and you have port 9090 forwarded, you can go to http://localhost:9090 on the host machine.","In the prometheus section, find the version that is labeled LTS.","In your terminal, download the file at the copied URL.","Move all of the Prometheus files to /opt/prometheus.","Reload systemd daemons.","Set the new user as the owner of /opt/prometheus.","Start the Prometheus service.","The file will be downloaded to your machine. Unzip it.","The URL in the line above is just an example, use the actual URL you copied earlier.","To stay organized, remove the compressed file.","Under Architecture, choose amb64.","Under Operating System, choose linux.","Verify it works by going to http://[your server's IP address/hostname]:9090."]},{"l":"Add Authentication","p":["Right now, anyone who visits the URL will see all monitoring information. This could leak sensitive data. Prometheus has built-in basic authentication available for configuration.","First, a password hash must be created. You can use Python for this. Debian Linux comes preinstalled with Python 3.","Install python3-bcrypt.","Create a file called gen-pass.py.","Run the file with Python.","You will be prompted for a password. Enter a strong and unique password that you will use to log in to Prometheus's web user interface, then press Enter.","The password hash is output. Copy it.","Create a file called /opt/prometheus/web.yml.","For the username, choose any username you like. For the password hash, paste the password hash you copied earlier.","Edit /etc/systemd/system/prometheus.service to change the ExecStart line.","Reload systemd daemons.","Restart the Prometheus service.","Now, when you go to http://localhost:9090, a username/password prompt will appear. Enter the username and password you chose earlier to gain access."]},{"l":"Adding an Exporter","p":["Create a directory to store the exporters.","Create a new systemd service file at/etc/systemd/system/prometheus_node_exporter.service.","Edit /opt/prometheus/prometheus.yml.","Enable the exporter so it starts when the system starts.","Go to https://prometheus.io/download/.","In the node_exporter section, copy the listed URL. It will be labeled something like node_exporter-1.5.0.linux-amd64.tar.gz.","In your terminal, download the file at the copied URL.","Indented under the scrape_configs section, add the following.","Move the exporter executable to the exporters directory.","Prometheus comes with some basic metrics to monitor by default, but you'll want to use \"exporters\" which provide access to even more metrics. There are metrics for your hardware and OS (the \"Node exporter\" node_exporter), MySQL/MariaDB(the \"MySQL Server Exporter\" mysqld_exporter), and more.","Reload systemd daemons","Remove the compressed file.","Remove the remaining files.","Restart the Prometheus service.","Start the exporter","The binary you just copied is still owned by your user account. Change the ownership of it (and all other files in /opt/prometheus for good measure).","Under Architecture, choose amb64.","Under Operating System, choose linux.","Unzip the file.","Verify it works by going to http://localhost:9090/graph?g0.expr=rate(node_disk_io_time_seconds_total[1m]). That page will show you the rate of I/O operations of your system disks."]}],[{"l":"Using a Development Database"},{"l":"Prerequisites","p":["A production database in MariaDB"]},{"l":"Create a Sync Script","p":["Instead of creating a development database by typing in commands manually, it is better to create a script. This way, you can sync the development database with the production one at any time with one command.","Create a sync script at /usr/local/bin/sync_dev_db.sh.","Make sure you replace [production database name] in the script above with the actual name of your production database.","Make the script executable."]},{"i":"createsync-the-development-database","l":"Create/Sync the Development Database","p":["The method in this section will erase all existing data in the development database, if it exists.","Run the sync script.","A database that is an exact duplicate of your production database now exists in MariaDB. The name has _dev appended to it. For example, if your production database is called mydatabase, there is now a database called mydatabase_dev.","Run this script any time you want to sync the data from production to development."]}]]